<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Apartment Admin Dashboard</title>
    <th:block th:replace="base :: bootstrap"></th:block>
    <style>
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .form-section {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div th:replace="base :: header"></div>

    <main class="container mt-4">
        <h2 class="mb-4">Tạo hóa đơn</h2>

        <!-- Hiển thị thông báo lỗi hoặc thành công -->
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

        <form th:action="@{/invoice/create}" method="post" th:object="${invoice}" onsubmit="return validateForm()">
            <!-- User Selection -->
            <div class="mb-3 form-section">
                <label class="form-label">Người dùng <span class="text-danger">*</span></label>
                <select class="form-select" th:field="*{userId.id}" required>
                    <option value="">-- Chọn người dùng --</option>
                    <option th:each="u : ${users}" th:value="${u.id}" th:text="${u.fullName + ' (' + u.username + ')'}"></option>
                </select>
                <div class="error" th:if="${#fields.hasErrors('userId.id')}">
                    <span th:errors="*{userId.id}"></span>
                </div>
            </div>

            <!-- Due Date -->
            <div class="mb-3 form-section">
                <label class="form-label">Ngày hết hạn <span class="text-danger">*</span></label>
                <input type="date" class="form-control" th:field="*{dueDate}" required />
                <div class="error" th:if="${#fields.hasErrors('dueDate')}">
                    <span th:errors="*{dueDate}"></span>
                </div>
            </div>

            <!-- Fee Selection -->
            <div class="mb-3 form-section">
                <label class="form-label">Loại phí <span class="text-danger">*</span></label>
                <select class="form-select" name="feedId" id="feedId" required>
                    <option value="">-- Chọn loại phí --</option>
                    <option th:each="fee : ${fees}" th:value="${fee.id}" th:text="${fee.name}"></option>
                </select>
            </div>

            <!-- Amount -->
            <div class="mb-3 form-section">
                <label class="form-label">Số tiền <span class="text-danger">*</span></label>
                <input type="number" step="0.01" class="form-control" name="amount" id="amount" required placeholder="Nhập số tiền" min="0.01" />
            </div>

            <!-- Note -->
            <div class="mb-3 form-section">
                <label class="form-label">Ghi chú</label>
                <input type="text" class="form-control" name="note" id="note" placeholder="Nhập ghi chú (tùy chọn)" />
            </div>

            <!-- Total Amount (Display Only) -->
            <div class="mb-3 form-section">
                <label class="form-label">Tổng tiền</label>
                <input type="number" step="0.01" class="form-control" th:field="*{totalAmount}" id="totalAmount" readonly />
            </div>

            <button type="submit" class="btn btn-primary mt-3">Tạo hóa đơn</button>
        </form>
    </main>

    <div th:replace="base :: footer"></div>
    <script>
        function validateForm() {
            const userId = document.querySelector('select[name="userId.id"]').value;
            const dueDate = document.querySelector('input[name="dueDate"]').value;
            const feedId = document.getElementById('feedId').value;
            const amountInput = document.getElementById('amount');
            const amount = parseFloat(amountInput.value);

            // Kiểm tra người dùng
            if (!userId) {
                alert('Vui lòng chọn người dùng.');
                document.querySelector('select[name="userId.id"]').focus();
                return false;
            }

            // Kiểm tra ngày hết hạn
            if (!dueDate) {
                alert('Vui lòng chọn ngày hết hạn.');
                document.querySelector('input[name="dueDate"]').focus();
                return false;
            }

            // Kiểm tra loại phí
            if (!feedId) {
                alert('Vui lòng chọn một loại phí.');
                document.getElementById('feedId').focus();
                return false;
            }

            // Kiểm tra số tiền
            if (isNaN(amount) || amount <= 0) {
                alert('Vui lòng nhập số tiền hợp lệ (lớn hơn 0).');
                amountInput.focus();
                return false;
            }

            // Cập nhật tổng số tiền
            document.getElementById('totalAmount').value = amount.toFixed(2);
            return true;
        }

        // Cập nhật tổng số tiền khi nhập số tiền
        document.getElementById('amount').addEventListener('input', function () {
            const amount = parseFloat(this.value) || 0;
            document.getElementById('totalAmount').value = amount.toFixed(2);
        });

        // Debug
        console.log('Form validation script loaded');
    </script>
</body>
</html>