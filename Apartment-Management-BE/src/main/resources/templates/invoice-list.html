<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Danh sách hóa đơn</title>
    <th:block th:replace="base :: bootstrap"></th:block>
    <style>
        .table-container {
            margin-top: 2rem;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <div th:replace="base :: header"></div>

    <main class="container mt-4">
        <h2 class="mb-4">Danh sách hóa đơn</h2>

        <!-- Nút Create Invoice -->
        <div class="mb-3">
            <a th:href="@{/invoice/create}" class="btn btn-success">Tạo hóa đơn mới</a>
        </div>

        <!-- Hiển thị thông báo lỗi hoặc thành công -->
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

        <!-- Bảng hiển thị danh sách hóa đơn -->
        <div class="table-container">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Người dùng</th>
                        <th>Ngày phát hành</th>
                        <th>Ngày hết hạn</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Phương thức thanh toán</th>
                        <th>Chi tiết</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="invoice : ${invoices}">
                        <td th:text="${invoice.id}"></td>
                        <td th:text="${invoice.userId.fullName} + ' (' + ${invoice.userId.username} + ')'"></td>
                        <td th:text="${#dates.format(invoice.issuedDate, 'dd-MM-yyyy')}"></td>
                        <td th:text="${invoice.dueDate != null} ? ${#dates.format(invoice.dueDate, 'dd-MM-yyyy')} : 'Không có'"></td>
                        <td th:text="${invoice.totalAmount}"></td>
                        <td th:text="${invoice.status}"></td>
                        <td th:text="${invoice.paymentMethod != null} ? ${invoice.paymentMethod} : 'Chưa thanh toán'"></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-info" 
                                    data-bs-toggle="modal" 
                                    th:attr="data-bs-target='#detailsModal' + ${invoice.id}"
                                    onclick="console.log('Opening modal for invoice: ' + ${invoice.id})">
                                Xem chi tiết
                            </button>
                        </td>
                        <td>
                            <a th:href="#" class="btn btn-sm btn-primary">Sửa</a>
                            <a th:href="@{/invoices/delete(id=${invoice.id})}" class="btn btn-sm btn-danger"
                               onclick="return confirm('Bạn có chắc muốn xóa hóa đơn này?')">Xóa</a>
                        </td>
                    </tr>
                    <tr th:if="${invoices.isEmpty}">
                        <td colspan="9" class="text-center">Không có hóa đơn nào.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Modal hiển thị chi tiết hóa đơn -->
        <div th:each="invoice : ${invoices}" 
             class="modal fade" 
             th:id="'detailsModal' + ${invoice.id}" 
             tabindex="-1" 
             aria-labelledby="detailsModalLabel" 
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailsModalLabel">Chi tiết hóa đơn #<span th:text="${invoice.id}"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Debug: Số lượng chi tiết: <span th:text="${invoice.detailInvoiceSet.size()}"></span></p>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Loại phí</th>
                                    <th>Số tiền</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="detail : ${invoice.detailInvoiceSet}">
                                    <td th:text="${detail.feedId != null && detail.feedId.name != null} ? ${detail.feedId.name} : 'Không có'"></td>
                                    <td th:text="${detail.amount != null} ? ${detail.amount} : 'Không có'"></td>
                                    <td th:text="${detail.note != null} ? ${detail.note} : 'Không có'"></td>
                                </tr>
                                <tr th:if="${invoice.detailInvoiceSet.isEmpty}">
                                    <td colspan="3" class="text-center">Không có chi tiết hóa đơn.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="base :: footer"></div>
</body>
</html>